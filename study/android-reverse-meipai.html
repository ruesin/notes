<!DOCTYPE HTML>
<html>
  <head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="utf-8">
    <meta name="renderer" content="webkit|ie-comp|ie-stand">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no">
    <title>【安卓逆向】获取美拍APP签名算法-信口开河</title>
    <meta name="keywords" content="Ruesin,信口开河">
    <meta name="description" content="至于你信不信，反正我是信了。">
    <link rel="stylesheet" href="/css/style.css">
</head>
  <body>
    
<header class="header">
    <nav class="navbar">
        <ul>
            
            <li><a class="header-nav-link" href="/">首页</a></li>
            
            <li><a class="header-nav-link" href="/categories">分类</a></li>
            
            <li><a class="header-nav-link" href="/archives">归档</a></li>
            
            <li><a class="header-nav-link" href="/tags">标签</a></li>
            
            <li><a class="header-nav-link" href="https://github.com/ruesin/notes">Github</a></li>
            
            <li><a class="header-nav-link" href="https://ruesin.github.io/php-tree">PHP技能树</a></li>
            
            <li><a class="header-nav-link" href="https://www.xinkoukaihe.com">老博客</a></li>
            
        </ul>
    </nav>
</header>
    <main class="main">
      <!-- 内容页 -->
<section class="section">
    <div class="post-container">
        <div class="post-header">
                <h1>【安卓逆向】获取美拍APP签名算法</h1>
                <!-- <div class="post-meta">2019-07-28</div> -->
        </div>
        <article class="post-content">
            <p>美拍版本是<code>8.2.38</code>，通过本次逆向整理了下安卓APP的完整逆向过程。</p>
<h2 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h2><p>安卓逆向，需要反编译APK并获取源码，主要用到工具：</p>
<ul>
<li><a href="https://ibotpeaches.github.io/Apktool/install/" target="_blank" rel="noopener">ApkTool</a>：<br>有对APK的编译、反编译、签名等功能，可利用ApkTool查看apk的xml文件、AndroidManifest.xml和图片等<ol>
<li>下载<code>apktool</code>及<code>apktool_2.4.0.jar</code>，将<code>apktool_2.4.0.jar</code>重命名为<code>apktool.jar</code></li>
<li>将<code>apktool.jar</code>和<code>apktool</code>移动到<code>/usr/local/bin</code>目录下，并增加可执行权限</li>
<li>在终端输入apktool看是否可以运行，如果不可以需要在系统偏好设置中打开安全与隐私中点击仍要运行apktool.jar</li>
</ol>
</li>
<li><a href="https://sourceforge.net/projects/dex2jar/files/" target="_blank" rel="noopener">dex2jar</a>：<br>将dex文件转换成jar文件，转换成jar后我们才好借助JD-GUI来查看反编译dex后的代码</li>
<li><a href="http://jd.benow.ca/" target="_blank" rel="noopener">JD-GUI</a>：<br>一款Java反编译器GUI，通过它查看反编译后的dex的代码，通常需要配合dex2jar使用</li>
</ul>
<h2 id="反编译apk"><a href="#反编译apk" class="headerlink" title="反编译apk"></a>反编译apk</h2><p>使用<code>ApkTool</code>反编译APK得到xml文件、AndroidManifest.xml和图片</p>
<pre><code class="shell">$ cd /Users/sin/Desktop/mp
$ apktool d meipai.apk</code></pre>
<p>如果在反编译时出现警告：</p>
<pre><code>S: WARNING: Could not write to (/Users/sin/Library/apktool/framework), using /var/folders/x9/pbjwtndx1sl9cgy_qdmyb17r0000gn/T/ instead...
S: Please be aware this is a volatile directory and frameworks could go missing, please utilize --frame-path if the default storage directory is unavailable
I: Loading resource table from file: /var/folders/x9/pbjwtndx1sl9cgy_qdmyb17r0000gn/T/1.apk</code></pre><p>创建对应目录即可：</p>
<pre><code class="shell">mkdir -p /Users/sin/Library/apktool/framework</code></pre>
<p>也可以将文件夹编译为apk<code>apktool b meipai -o new_meipai.apk</code>，在<code>meipai</code>文件夹中生成<code>build</code>、<code>dist</code>两个文件夹，这就是编译后生成的文件，<code>new_meipai.apk</code>在<code>dist</code>中。</p>
<p>如果重新打包时报错：<code>W: /Users/sin/Desktop/android/meipai/res/color/x.xml:6: error: No resource identifier found for attribute &#39;alpha&#39; in package &#39;com.meitu.meipaimv&#39;</code>。编译的时候找不到资源id，通过查apktool的命令帮助，可以通过-r参数来避免resc的反编译，在重新打包时就不会重新编译resc文件包括xml，<code>apktool -r d dou2.apk -o test</code>。</p>
<p><code>APkTool</code>只是将资源文件提取处理，对于.dex类型的文件是无法查看的，需要用<code>dex2jar</code>转换代码。</p>
<h2 id="dex转jar"><a href="#dex转jar" class="headerlink" title="dex转jar"></a>dex转jar</h2><p>使用解压软件将<code>meipai.apk</code>进行解压，也可更改文件后缀为<code>meipai.zip</code>，然后解压。</p>
<p>解压后的classes.dex文件就是项目的源码，如果使用了<code>MultiDex</code>将会有多个dex文件，将dex文件拷贝到dex2jar目录下。</p>
<pre><code class="shell">$ cd /Users/sin/Desktop/mp/dex2jar-2.0
$ chmod +x *.sh
$ ./d2j-dex2jar.sh classes.dex
$ ./d2j-dex2jar.sh classes2.dex
$ ./d2j-dex2jar.sh classes3.dex
$ ./d2j-dex2jar.sh classes4.dex
$ ./d2j-dex2jar.sh classes5.dex</code></pre>
<p>也可以直接解APK文件：<code>./d2j-dex2jar.sh /Users/sin/Desktop/mp/meipai.apk</code></p>
<p>使用解压软件打开apk 和使用apktool反编译出的apk不同：</p>
<ul>
<li>直接解压apk和使用apktool反编译apk都能获得AndroidManifest.xml，但直接解压获得的AndroidManifest.xml是乱码的，无法直接查看</li>
<li>直接解压apk获得res资源文件是不包含resources.arsc部分的，而使用apktool反编译出来的res是包含的</li>
</ul>
<h2 id="JD-GUI查看Jar代码"><a href="#JD-GUI查看Jar代码" class="headerlink" title="JD-GUI查看Jar代码"></a>JD-GUI查看Jar代码</h2><p>直接运行<code>JD-GUI.app</code>，将<code>classes-dex2jar.jar</code>拖拽到JD-GUI界面上即可。</p>
<h2 id="查找签名"><a href="#查找签名" class="headerlink" title="查找签名"></a>查找签名</h2><p>在<code>JD-GUI</code>中可搜索关键词，比如抓包的feed流地址：<code>https://api.meipai.com/hot/feed_timeline.json?is_from_scroll=0&amp;page=5&amp;memory=2&amp;guid=a6aa36a625129418e5da01bc2a8d6a8c&amp;sdk_version=4.6.1-201905071358%40aar&amp;timestamp=1565584900671&amp;timezone=GMT%2B8&amp;is_root=2&amp;carrier=&amp;device_brand=HUAWEI&amp;user_agent=Mozilla%252F5.0%2B%2528Linux%253B%2BAndroid%2B6.0.1%253B%2BMate%2B10%2BPro%2BBuild%252FV417IR%253B%2Bwv%2529%2BAppleWebKit%252F537.36%2B%2528KHTML%252C%2Blike%2BGecko%2529%2BVersion%252F4.0%2BChrome%252F52.0.2743.100%2BMobile%2BSafari%252F537.36&amp;language=zh-Hans&amp;client_id=1089857302&amp;device_id=008796751994005&amp;version=8238&amp;channel=meipai_setupbutton&amp;model=Mate+10+Pro&amp;os=6.0.1&amp;origin_channel=meipai_setupbutton&amp;imei=008796751994005&amp;mac=02%3A00%3A00%3A00%3A00%3A00&amp;stat_gid=1898125227&amp;android_id=e37be4c3555be003&amp;local_time=1565584901542&amp;lat=39.912591&amp;lon=116.539574&amp;network=wifi&amp;resolution=800*1280&amp;teenager_status=0&amp;sig=49b8427a8ccef6f6901db24128fa382d&amp;sigVersion=1.3&amp;sigTime=1565584901566</code></p>
<p>通过搜索<code>sigTime</code>，很快定位到签名类位于<code>com.meitu.secret.SigEntity</code>类中，此类中提供了几个签名方法，如果不知道是哪个，可以继续翻代码或者hook。</p>
<p>这里我们已经知道外部调用的是<code>generatorSigWithFinal</code>方法，而此方法中最终调用的是一个<code>native</code>方法<code>nativeGeneratorSigFinal</code>，此方法定义在<code>.so</code>文件中。</p>
<p>通过阅读此类，<code>System.loadLibrary(&quot;release_sig&quot;);</code>，发现调用的是<code>librelease_sig.so</code>文件，此文件在<code>./lib/armeabi-v7a/librelease_sig.so</code></p>
<h2 id="使用Xposed-HOOK"><a href="#使用Xposed-HOOK" class="headerlink" title="使用Xposed HOOK"></a>使用Xposed HOOK</h2><p>通过阅读jar代码，一般情况下可以拼接出参数，但是比较复杂的时候，最好的办法还是hook，具体的hook代码可参考 <a href="https://github.com/ruesin/sinXposed" target="_blank" rel="noopener">https://github.com/ruesin/sinXposed</a></p>
<p>通过hook，可以拿到<code>native</code>方法<code>nativeGeneratorSigFinal</code>的参数：</p>
<pre><code>07-29 14:58:37.166  5960  6579 I test: test paramString0: friendships/followers.json
07-29 14:58:37.166  5960  6579 I test: test paramString1-1: [1644140716, 3, zh-Hans, 1089857302, 008796751994005, 8238, meipai_setupbutton, Mate 10 Pro, 6.0.1, meipai_setupbutton, 008796751994005, 02:00:00:00:00:00, 1898125227, e37be4c3555be003, 1564383517163, 39.912602, 116.539565, wifi, 800*1280, 0]
07-29 14:58:37.166  5960  6579 I test: test paramString2: 10001
07-29 14:58:37.166  5960  6579 I test: test paramString3: com.meitu.meipaimv.MeiPaiApplication@5f73d9e
07-29 14:58:37.166  5960  6579 I test: test result: com.meitu.secret.SigEntity@d4eb541</code></pre><h2 id="解析-so-文件"><a href="#解析-so-文件" class="headerlink" title="解析 so 文件"></a>解析 so 文件</h2><p>解析so文件可以使用<code>IDA</code>或<code>Hopper</code>，这里使用的是<a href="https://www.hex-rays.com/products/ida/" target="_blank" rel="noopener">IDA</a>。</p>
<p>通过<code>IDA</code>打开<code>librelease_sig.so</code>文件后，可在左侧边栏快速定位方法<code>Java_com_meitu_secret_SigEntity_nativeGeneratorSigFinal</code>。</p>
<p>双击打开方法后，按<code>F5</code>转成<code>C</code>代码，大概能够看出这个方法是对字符串做了系列处理，然后md5的，另外还做了加盐处理，具体加盐可以搜索字符串：<code>⇧+F12</code>打开字符串列表窗口，在窗口内搜索。</p>
<h2 id="签名"><a href="#签名" class="headerlink" title="签名"></a>签名</h2><p>将解析的签名代码翻译成伪代码，并使用同样的参数进行签名，对比是否一致。</p>
<h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><p>美拍签名是比较简单的，在JAVA中加载so，然后调用so中的方法。so中的方法也比较简单，通过分析即可写出伪代码。</p>
<p>在其他很多时候，我们在hook到代码后，可能无法直接分析so文件，或者分析so很困难。这时可以自建空白安卓项目，引入so文件，模拟调用so方法，然后在IDA中断点调试。</p>

        </article>
    </div>
</section>

    </main>
    <footer class="footer"> Copyright 2013 - 2019 Ruesin. All Rights Reserved </footer>
  </body>
</html>