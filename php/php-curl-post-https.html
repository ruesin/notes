<!DOCTYPE HTML>
<html>
  <head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="utf-8">
    <meta name="renderer" content="webkit|ie-comp|ie-stand">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no">
    <title>php 使用 curl post 请求 https-信口开河</title>
    <meta name="keywords" content="Ruesin,信口开河">
    <meta name="description" content="至于你信不信，反正我是信了。">
    <link rel="stylesheet" href="/css/style.css">
</head>
  <body>
    
<header class="header">
    <nav class="navbar">
        <ul>
            
            <li><a class="header-nav-link" href="/">首页</a></li>
            
            <li><a class="header-nav-link" href="/categories">分类</a></li>
            
            <li><a class="header-nav-link" href="/archives">归档</a></li>
            
            <li><a class="header-nav-link" href="/tags">标签</a></li>
            
            <li><a class="header-nav-link" href="https://github.com/ruesin/notes">Github</a></li>
            
            <li><a class="header-nav-link" href="https://ruesin.github.io/php-tree">PHP技能树</a></li>
            
            <li><a class="header-nav-link" href="https://www.xinkoukaihe.com">老博客</a></li>
            
        </ul>
    </nav>
</header>
    <main class="main">
      <!-- 内容页 -->
<section class="section">
    <div class="post-container">
        <div class="post-header">
                <h1>php 使用 curl post 请求 https</h1>
                <!-- <div class="post-meta">2015-11-02</div> -->
        </div>
        <article class="post-content">
            <p>今天做wap请求微信APP支付， PHP端要post请求API生成预支付订单，获取订单号。</p>
<p>请求地址为：</p>
<p><a href="https://api.weixin.qq.com/pay/genprepay?access\_token=ACCESS\_TOKEN" target="_blank" rel="noopener">https://api.weixin.qq.com/pay/genprepay?access\_token=ACCESS\_TOKEN</a></p>
<p>请求方法是要post，json数据。</p>
<p>本来，这些都没什么，在原来封装的curl方法中加个header参数即可。可是实际测试时，一直返回false，拿本地的url测试，又是正常，翻了半天没想通理由，按照官方文档来说，如果是json格式错误，起码应有个错误码啊。</p>
<p>于是，开始对比本地url和远端API的不同，终于，最后发现了不同所在，微信api使用的是https，而且在人家官方文档的开始就已经声明了，自己没注意到而已。</p>
<p>知道了问题所在就好解决了，当请求https的数据时，会要求证书，在请求时加上两个参数，忽略下ssl的证书检查好了。</p>
<pre><code>function postJsonCurl($url, $data_string) {
    $ch = curl_init();
    curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false); // 跳过证书检查
    curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, true);  // 从证书中检查SSL加密算法是否存在
    curl_setopt($ch, CURLOPT_URL, $url);
    curl_setopt($ch, CURLOPT_HTTPHEADER, array(
        &#39;Content-Type: application/json; charset=utf-8&#39;,
        &#39;Content-Length: &#39; . strlen($data_string))
    );
    curl_setopt($ch, CURLOPT_POST, true);
    curl_setopt($ch, CURLOPT_POSTFIELDS, $data_string);
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
    curl_setopt($ch, CURLOPT_CONNECTTIMEOUT, 300);

    ob_start();
    curl_exec($ch);
    $result= ob_get_contents();
    ob_end_clean();
    return $result;
}</code></pre>
        </article>
    </div>
</section>

    </main>
    <footer class="footer"> Copyright 2013 - 2019 Ruesin. All Rights Reserved </footer>
  </body>
</html>